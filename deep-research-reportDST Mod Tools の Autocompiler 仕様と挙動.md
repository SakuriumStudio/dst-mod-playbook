# DST Mod Tools の Autocompiler 仕様と挙動

**概要:** Don't Starve Together（DST）用の「Don't Starve Mod Tools」には、自動的に画像（.png）やSpriterプロジェクト（.scml）をゲーム用ファイルに変換する**オートコンパイラ（autocompiler）**が含まれています。Mod Tools をインストールした状態で DST を起動すると、自動でコマンドプロンプト（黒いコンソール）が開き、`bigportraits/`や`images/`内のPNGを`.tex`/.`xml`に、`exported/`内のSCMLを`anims/`の.zip（`build.bin`・`anim.bin`・`atlas-0.tex` などを含む）に変換します【58†L243-L252】【49†L326-L334】。  

- **png→tex/xml:** 大ポートレイトやキャラ名画像のPNGは、同名の`.tex`と`.xml`として同じフォルダに出力されます（例：`bigportraits/あなた.png`→`bigportraits/あなた.tex`＋`bigportraits/あなた.xml`）【58†L243-L252】【65†L233-L239】。  
- **.scml→.zip:** `exported/`以下にあるキャラ用フォルダ内の`.scml`ファイルは、`anims/`フォルダにキャラ名.zipとして出力されます（例：`exported/あなた/あなた.scml`→`anims/あなた.zip`）。このZipには`build.bin`や`anim.bin`、`atlas-0.tex`などが含まれ、ゲームで利用可能なアニメーション形式になります【65†L233-L239】【58†L243-L252】。  

以下に代表的な入力→出力例を示します：

| 元ファイル例                        | 生成ファイル例                   | 保存先フォルダ    |
|:-------------------------------|:---------------------------|:---------------|
| `bigportraits/あなた_none.png`        | `あなた_none.tex`, `あなた_none.xml` | `bigportraits/` |
| `images/names_あなた.png`            | `names_あなた.tex`, `names_あなた.xml` | `images/`      |
| `exported/あなた/あなた.scml`       | `あなた.zip` (内包: `build.bin`, `anim.bin`, `atlas-0.tex`…) | `anims/`       |
| （DST用）`bigportraits/modicon.png` | `modicon.tex`, `modicon.xml`   | `bigportraits/`※後ほど移動処理【30†L159-L163】 |

※最後の modicon は大ポートレイトと同じく`bigportraits/`で変換され、その後ワークスペースに戻す必要があります【30†L159-L163】。  

## (1) tex/xml 生成の仕組みと条件

- **起動時トリガー:** DST を起動すると、DST本体とは別プロセスでオートコンパイラが呼ばれます。Mod Toolsが正しくインストールされていれば、ゲーム開始時に自動で変換処理が実行され、PNG→tex/xml、SCML→zip 変換が走ります【58†L243-L252】【49†L326-L334】。  
- **対象フォルダ:** Modフォルダ直下の特定フォルダが対象です。具体的には、`bigportraits/`および`images/`内のPNGファイルと、`exported/キャラ名/`内のSCMLファイルが対象になります。出力は元と同じフォルダ（または`anims/`）に行われます【58†L243-L252】【65†L233-L239】。  
- **書き出しの条件:** 画像を追加・更新した場合、再度オートコンパイラを実行（起動し直すか手動実行）することで新しい`.tex/.xml`が生成されます。元ファイル（.png, .scml）の名前とフォルダ構造が正しくないと認識されず、変換されないので注意します【65†L233-L239】【58†L243-L252】。  

## (2) 実行トリガーの種類

- **自動実行（ゲーム起動時）:** Mod Tools が DST と同一ドライブ・ディレクトリ構造に配置されていれば、DST 起動時に自動的にオートコンパイラが起動します【49†L326-L334】【58†L243-L252】。  
- **手動実行:** 必要に応じて任意に実行できます。具体的には、Mod Tools フォルダ内の`autocompiler.exe`を直接実行すれば、手動でコンパイル処理が行われます【58†L243-L252】【23†L648-L656】。また、SCMLファイル単独の場合は`scml.exe`、画像単独の場合は`png.exe`ツールを使う方法もあります【58†L253-L262】【30†L159-L163】。  

## (3) 手動実行の具体的操作

1. **autocompiler.exe の実行:**  
   Windows なら、例としてコマンドプロンプトを開き以下を実行します（環境に合わせてパスを変更）。  
   ```bat
   cd "C:\Program Files (x86)\Steam\steamapps\common\Don't Starve Mod Tools\mod_tools"
   autocompiler.exe
   ```  
   これでコンソールが表示され、変換処理が始まります【58†L243-L252】【23†L648-L656】。処理後、出力ファイルが所定フォルダに生成されます。  
2. **scml.exe の実行:**  
   `.scml`単独のコンパイルには`scml.exe`を使えます。コマンドプロンプトで`scml.exe`のパス、入力SCML、出力先Modフォルダを指定します【58†L252-L261】。例：  
   ```bat
   "C:\...\mod_tools\scml.exe" "C:\...\mods\YourMod\exported\YourChar\YourChar.scml" "C:\...\mods\YourMod\"
   ```  
   こうすると`YourMod\anims\YourChar.zip`が生成されます。  
3. **png.exe の実行:**  
   単一のPNGを変換したい場合は`png.exe`を使用できます（実行後に`.tex`と`.xml`が生成される）。例：  
   ```bat
   "C:\...\mod_tools\png.exe" "C:\...\mods\YourMod\images\someImage.png" "someImage.tex"
   ```  
   出力ファイル名の指定方法はツールに依存しますが、公式ドキュメントでは入力PNGをドラッグ＆ドロップして出力を得る方法も案内されています【65†L273-L281】【30†L159-L163】。  

実行中にエラーが出た場合、`mod_tools\temp\autocompiler_log.txt`にログが記録されます【23†L694-L700】。問題が起きたら必ずこのログを確認してください。

## (4) 出力ファイルの保存場所・命名規則

オートコンパイラは基本的に**元ファイルと同名**の.tex/.xmlを生成します。代表例は下表のとおりです。  

| 元ファイル                                | 生成ファイル                           | 保存先フォルダ              |
|:-------------------------------------|:---------------------------------|:------------------------|
| `bigportraits/キャラ.png`                | `キャラ.tex`, `キャラ.xml`        | `bigportraits/`         |
| `images/names_キャラ.png`              | `names_キャラ.tex`, `names_キャラ.xml` | `images/`               |
| `exported/キャラ/キャラ.scml`          | `キャラ.zip`（内包: `build.bin`, `anim.bin`, `atlas-0.tex`, など） | `anims/`                |
| （DST用）`bigportraits/modicon.png`     | `modicon.tex`, `modicon.xml`      | `bigportraits/`**※**  |

※ modiconは変換後に**大ポートレイトフォルダから適切な場所へ移動**します【30†L159-L163】。  

ファイル名はいずれも元PNG/SCMLと同じベース名になります。**複数のPNGが同名の場合（大ポートレイト用の `_none` 版など）**には、正しく命名し直す必要があります（マニュアルでXML中のElement名を修正する手順が公式チュートリアルで案内されています【58†L269-L278】）。  

## (5) 典型的な失敗パターンと検出方法

- **コンソールが開かない/すぐ閉じる:** オートコンパイラが起動すらしていない状態です。多くは **DST本体とMod Toolsが異なるドライブにインストールされている** ために起こります【41†L109-L117】【49†L326-L334】。この場合、オートコンパイラは「modsフォルダ」が見つからず即終了します。検出方法としては、`mod_tools\temp\autocompiler_log.txt`にエラー（パス未検出など）がないか確認しましょう【23†L694-L700】。また、DST のプレイヤーログ（`Documents\Klei\DoNotStarveTogether\client_log.txt`）にもロード失敗の情報が残る場合があります【65†L344-L352】。  
- **SCML/PNGを変換してくれない:** 以下のような原因が考えられます：  
  - **ファイル配置ミス:** 画像は必ず `bigportraits/` または `images/` に、SCMLは `exported/キャラ名/` に配置する必要があります。フォルダやファイル名に誤りがあると無視されます。  
  - **旧ファイルの残存:** 同名の `.zip` (アニメファイル) や `.tex/.xml` が残っていると、オートコンパイラが上書きしない場合があります。特にキャラ名変更時は `anims/古いキャラ名.zip` を削除してください【65†L232-L239】。  
  - **変換エラー:** SCMLや画像に問題があると変換に失敗します。`autocompiler_log.txt` を見ると、「BuildError」「Atlas building failed」などのメッセージが出力されていないか確認できます。  
- **変換ファイルがゲームで使えない:** 既知の問題として、生成されたアニメーションの属性（フレームレートやシンボル名の扱い）に不具合が出ることがあります【21†L458-L466】。これを検出するには、生成後にゲーム内でモデルやアニメが正しく動作するか確認し、異常があればコンパイル方法（ループ設定など）を見直します。  

## (6) 主なトラブル事例と原因分析

- **テンプレート改名後に.tex/.xmlが生成されない:** これは **オートコンパイラが起動していないか、ファイル名の置換漏れ** が原因です。たとえば「esctemplate」を新キャラ名に置換する際、大文字/小文字両方を置換し忘れると正しく処理されません【65†L226-L234】。さらに、古い`esctemplate.zip`が残っていると新しいアニメが作れません【65†L232-L239】。対策としては、テンプレート名の全置換を確実に行い（`esctemplate`→`あなた`, `ESCTEMPLATE`→`あなた`）、旧ファイルを削除した上でオートコンパイラを再実行します。自動実行されない場合は手動起動し、ログに出力があるか確認しましょう。  
- **オートコンパイラ（黒いコンソール）が表示されない:** 先述のとおり**Mod ToolsとDSTを同一ドライブに置いていない**などのパス問題が大半です【41†L109-L117】【49†L326-L334】。また、オートコンパイラ設定が不明瞭な状態になることも。対策として、Mod Tools を DST と同じSteamライブラリ/ドライブにインストールし直し、DSTを再起動します。それでも動かなければ、Mod Toolsフォルダから直接`autocompiler.exe`をコマンド実行し、エラーを目視します。  
- **旧チュートリアル通り.tex/xmlを削除しても再生成されない:** 旧い情報では「画像ファイル名に合わせて古い`.tex`/`.xml`を消せ」とありますが、**その後オートコンパイラで再生成する操作を抜かしてはいけません**。削除後は必ずDSTを起動（または手動実行）して再コンパイルしましょう。また、旧情報と現在のツール仕様が異なるケースもあるため、Klei公式チュートリアル【28†L218-L225】【58†L243-L252】など最新版に沿って手順を確認すると安心です。

## (7) トラブル解決チェックリスト

1. **Mod Toolsの配置確認:** DST本体とMod Toolsは同一ドライブかつ同階層に配置する必要があります【49†L326-L334】【41†L109-L117】。設定ミスがないか確認し、必要なら再インストール・移動します。  
2. **フォルダ・ファイル名の確認:** `exported/キャラ名/` と `anims/` 、`bigportraits/`、`images/` が正しく存在するかチェック。キャラ名・ファイル名の大文字小文字まで正しく置換されているか念入りに確認します【65†L226-L234】【58†L243-L252】。  
3. **旧ファイルの整理:** 既存の`.tex`/`.xml`（特に`bigportraits/`や`images/`内）や古い`.zip`（`anims/`内）を削除し、クリーンな状態にします【65†L232-L239】【58†L243-L252】。  
4. **手動コンパイル実行:** 必要に応じて以下を試します：  
   - DSTを再起動し、自動実行されるか確認【58†L243-L252】。  
   - `autocompiler.exe` を直接実行してみる【58†L243-L252】【23†L648-L656】。  
   - SCMLまたはPNGの個別実行：`scml.exe` や `png.exe` を用いて手動コンバートする（例：[58†L252-L261] を参照）。  
5. **ログの確認:** `mod_tools\temp\autocompiler_log.txt` を開き、エラーや警告がないか調べます【23†L694-L700】。問題が見つかれば、その内容で検索・対応します。DSTのクライアントログ（`Documents\Klei\DoNotStarveTogether\client_log.txt`）も参考にします【65†L344-L352】。  
6. **生成結果の確認:** 変換後、`bigportraits/`や`images/`に`.tex/.xml`、`anims/`に`.zip`が生成されているか確認します。不足があれば、再度手順1～5を再チェックします。  
7. **再現性の確認:** 以上を試した後でも問題が継続する場合、テスト用の簡易Mod（雛形）で再現手順を試し、特定の操作で必ず失敗する条件を絞ります。こうすることで原因が明確になります（例：Drive問題なら別ドライブで発生するか確認）。  

以上のように、**生成条件・トリガーを押さえた上で、手順どおりに再コンパイルすること**が問題解決の近道です。DST Mod Tools／Autocompiler は仕様が専門的でややクセがありますが、一度動作をつかめば自動化で非常に強力です。がんばってクリアしましょう！【58†L243-L252】【49†L326-L334】

